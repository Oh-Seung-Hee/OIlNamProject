using System.Collections;
using System.Collections.Generic;
using TMPro;
using UnityEngine;

public class EnemySpawn : MonoBehaviour
{
    [SerializeField] private Transform[] wayPoints;
    //[SerializeField] private Enemy enemyPrefab;
    [SerializeField] private GameObject enemyPrefab;
    [SerializeField] private TMP_Text enemyCountText;

    public GameManager gameManager;
    public Player player;
    public DataManager dataManager;//임시//수정
    public GameSceneManager gameSceneManager;//수정
    private WaveUI waveUI;

    private List<Enemy> enemyList;
    private int maxPerWave = 40;    // wave 당 최대 마물 수
    private int currentCount = 0;
    public int deadEnemyCount = 0;  // 처리한 마물 수

    EnemyMove enemyMove;

    private void Awake()
    {
        // 생성된 마물을 넣어놓을 리스트 할당
        enemyList = new List<Enemy>();

        waveUI = GetComponent<WaveUI>();
        //enemyMove = enemyPrefab.GetComponent<EnemyMove>();
    }

    private void Start()
    {
        if (GameManager.Instance != null)
        {
            gameManager = GameManager.Instance;
            player = gameManager.Player;
            GameManager.Instance.EnemySpawn = this;
        }
        else
        {
            player = GameManager.Instance.Player;
        }

        StartCoroutine(SpawnEnemy());
    }

    // SpawnPoint에서 마물 생성
    private IEnumerator SpawnEnemy()
    {
        // 이번 Wave에 아직 생성되어야 할 마물이 있다면
        while (currentCount < maxPerWave)
        {
            CreateEnemy();

            yield return new WaitForSeconds(0.6f);
        }
    }

    // 마물을 생성한다.
    private void CreateEnemy()
    {
        // ********** TODO : 오브젝트 풀링 사용을 위해 수정되어야 함! 지금은 우선 오브젝트를 생성하는 방법임. **********
        // 마물에 대한 정보를 받아오는 것에 대해서도 생각 할 것
        //Instantiate(enemyPrefab, wayPoints[0].position, Quaternion.identity);
        //currentCount++;
        //enemyList.Add(enemyPrefab);

        //enemyMove = enemyPrefab.GetComponent<EnemyMove>();
        //enemyMove.Init(wayPoints);
        
        GameObject clone = Instantiate(enemyPrefab, wayPoints[0].position, Quaternion.identity);
        Enemy enemy = clone.GetComponent<Enemy>();
        enemy.Init(1, gameSceneManager, dataManager);//수정
        enemyMove = enemy.enemyMove;

        enemyMove.Init(wayPoints);
        enemyList.Add(enemy);

        currentCount++;
        UpdateEnemyCountUI();
    }

    // 마물 생성 코루틴 재시작
    public void RestartSpawnEnemy()
    {
        currentCount = 0;
        StartCoroutine(SpawnEnemy());
    }

    // ***임시*** 마물이 죽었을 때
    public void EnemyDie(Enemy enemy, GameObject gameObject)
    {
        // ***** TODO : 마물 죽었을 때 처리 방법 수정하기 *****
        //currentCount--;
        deadEnemyCount++;
        player.ExpUp(deadEnemyCount);
        enemyList.Remove(enemy);
        Destroy(gameObject);
        UpdateEnemyCountUI();

        // 소환된 마물이 다 죽었을 때
        if(enemyList.Count == 0)
        {
            waveUI.NextWave();
        }
    }

    // 마물 수 UI 업데이트
    private void UpdateEnemyCountUI()
    {
        enemyCountText.text = enemyList.Count.ToString() + " / 100";
    }
}
